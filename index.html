<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4-Channel Relay Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; background:#f4f4f9; color:#333; }
  h2 { margin-top: 20px; }
  .relay-container { margin: 15px auto; }
  button { width: 120px; height: 50px; font-size:18px; margin:5px; border:none; border-radius:10px; cursor:pointer; color:white; }
  button:active { transform:translateY(2px); }
  .on { background: limegreen; }
  .off { background: tomato; }
  .disabled { background: gray; cursor: not-allowed; }

  #espStatus, #mqttStatus { font-weight:bold; font-size:18px; margin-top:10px; }
  .online { color: limegreen; font-weight: bold; }
  .offline { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>4-Channel Relay Control</h2>

<div class="relay-container">
  <p>Relay 1 Status: <b id="relay1Status">--</b></p>
  <button id="relay1On" onclick="sendCommand(1,'ON')">ON</button>
  <button id="relay1Off" onclick="sendCommand(1,'OFF')">OFF</button>
</div>

<div class="relay-container">
  <p>Relay 2 Status: <b id="relay2Status">--</b></p>
  <button id="relay2On" onclick="sendCommand(2,'ON')">ON</button>
  <button id="relay2Off" onclick="sendCommand(2,'OFF')">OFF</button>
</div>

<div class="relay-container">
  <p>Relay 3 Status: <b id="relay3Status">--</b></p>
  <button id="relay3On" onclick="sendCommand(3,'ON')">ON</button>
  <button id="relay3Off" onclick="sendCommand(3,'OFF')">OFF</button>
</div>

<div class="relay-container">
  <p>Relay 4 Status: <b id="relay4Status">--</b></p>
  <button id="relay4On" onclick="sendCommand(4,'ON')">ON</button>
  <button id="relay4Off" onclick="sendCommand(4,'OFF')">OFF</button>
</div>

<hr>

<p>ESP Status: <span id="espStatus" class="offline">OFFLINE</span></p>
<p>ESP IP: <b id="espIP">--</b></p>
<p>ESP Uptime: <b id="espUptime">00:00:00</b></p>

<p id="mqttStatus">MQTT: Disconnected</p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';
  const options = {
    username: 'tohits',
    password: 'toh123@TOH',
    reconnectPeriod: 1000,
    clean: true,
    connectTimeout: 4000,
  };
  const client = mqtt.connect(broker, options);

  let relayStatus = [null,"OFF","OFF","OFF","OFF"]; // 1..4

  function updateRelayUI(ch){
    const statusEl = document.getElementById(`relay${ch}Status`);
    const onBtn = document.getElementById(`relay${ch}On`);
    const offBtn = document.getElementById(`relay${ch}Off`);

    statusEl.innerText = relayStatus[ch] || "--";

    if(relayStatus[ch]==="ON"){
      onBtn.className = "on";
      offBtn.className = "off";
    } else {
      onBtn.className = "off";
      offBtn.className = "on";
    }
  }

  function sendCommand(ch, cmd){
    if(client.connected){
      client.publish(`relay${ch}/control`, cmd);
    } else {
      alert("MQTT not connected!");
    }
  }

  // ---------- MQTT EVENTS ----------
  client.on('connect', () => {
    document.getElementById("mqttStatus").innerText = "MQTT: Connected ✅";
    document.getElementById("mqttStatus").style.color = "limegreen";
    client.subscribe([
      'relay1/status',
      'relay2/status', 
      'relay3/status',
      'relay4/status',
      'esp/+/status',     // ✅ FIX 1: Catches esp/1234/status, esp/5678/status
      'esp/+/ip',         // ✅ FIX 2: Catches esp/1234/ip
      'esp/+/uptime'      // ✅ FIX 3: Catches esp/1234/uptime
    ]);
  });

  client.on('reconnect', () => {
    document.getElementById("mqttStatus").innerText = "MQTT: Reconnecting...";
    document.getElementById("mqttStatus").style.color = "orange";
  });

  client.on('offline', () => {
    document.getElementById("mqttStatus").innerText = "MQTT: Offline";
    document.getElementById("mqttStatus").style.color = "red";
    const espStatus = document.getElementById('espStatus');
    espStatus.innerText = 'OFFLINE';
    espStatus.className = 'offline';
  });

  client.on('error', () => {
    document.getElementById("mqttStatus").innerText = "MQTT: Error";
    document.getElementById("mqttStatus").style.color = "red";
  });

  // ---------- MQTT Messages ----------
  client.on('message', (topic,message)=>{
    const msg = message.toString();

    // Relay status updates
    if(topic.match(/^relay[1-4]\/status$/)){
      const ch = parseInt(topic.charAt(5));
      relayStatus[ch] = msg;
      updateRelayUI(ch);
    }

    // ✅ FIX 4: ESP status from esp/XXXX/status
    if(topic.match(/^esp\/\d+\/status$/)){
      const espStatusEl = document.getElementById('espStatus');
      espStatusEl.innerText = msg;
      espStatusEl.className = (msg==="ONLINE") ? "online" : "offline";
    }

    // ✅ FIX 5: ESP IP from esp/XXXX/ip
    if(topic.match(/^esp\/\d+\/ip$/)){
      document.getElementById('espIP').innerText = msg;
    }

    // ✅ FIX 6: ESP uptime from esp/XXXX/uptime
    if(topic.match(/^esp\/\d+\/uptime$/)){
      document.getElementById('espUptime').innerText = msg;
    }
  });
</script>
</body>
</html>
