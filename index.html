<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4-Channel Relay Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; background:#f4f4f9; color:#333; }
  h2 { margin-top: 20px; }
  .relay-container { margin: 15px auto; padding: 10px; border-radius: 10px; background: #f9f9f9; }
  button { width: 120px; height: 50px; font-size:18px; margin:5px; border:none; border-radius:10px; cursor:pointer; color:white; }
  button:active { transform:translateY(2px); }
  .on { background: limegreen; }
  .off { background: tomato; }

  #espStatus, #mqttStatus { font-weight:bold; font-size:18px; margin-top:10px; }
  .online { color: limegreen; font-weight: bold; }
  .offline { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>4-Channel Relay Control ✅</h2>

<div class="relay-container">
  <p><b>Relay 1:</b> <span id="relay1Status" style="font-size:24px;">OFF</span></p>
  <!-- ✅ SWAPPED: OFF button FIRST, ON button SECOND -->
  <button id="relay1Off" class="on" onclick="sendCommand(1,'OFF')">OFF</button>
  <button id="relay1On" class="off" onclick="sendCommand(1,'ON')">ON</button>
</div>

<div class="relay-container">
  <p><b>Relay 2:</b> <span id="relay2Status" style="font-size:24px;">OFF</span></p>
  <!-- ✅ SWAPPED: OFF button FIRST, ON button SECOND -->
  <button id="relay2Off" class="on" onclick="sendCommand(2,'OFF')">OFF</button>
  <button id="relay2On" class="off" onclick="sendCommand(2,'ON')">ON</button>
</div>

<div class="relay-container">
  <p><b>Relay 3:</b> <span id="relay3Status" style="font-size:24px;">OFF</span></p>
  <!-- ✅ SWAPPED: OFF button FIRST, ON button SECOND -->
  <button id="relay3Off" class="on" onclick="sendCommand(3,'OFF')">OFF</button>
  <button id="relay3On" class="off" onclick="sendCommand(3,'ON')">ON</button>
</div>

<div class="relay-container">
  <p><b>Relay 4:</b> <span id="relay4Status" style="font-size:24px;">OFF</span></p>
  <!-- ✅ SWAPPED: OFF button FIRST, ON button SECOND -->
  <button id="relay4Off" class="on" onclick="sendCommand(4,'OFF')">OFF</button>
  <button id="relay4On" class="off" onclick="sendCommand(4,'ON')">ON</button>
</div>

<hr>
<p>ESP: <span id="espStatus" class="offline">OFFLINE</span></p>
<p>IP: <b id="espIP">--</b> | Uptime: <b id="espUptime">00:00:00</b></p>
<p id="mqttStatus">MQTT: Disconnected</p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const client = mqtt.connect('wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt', {
  username: 'tohits', password: 'toh123@TOH', reconnectPeriod: 1000
});

let relayStates = {1:'OFF', 2:'OFF', 3:'OFF', 4:'OFF'};

function updateRelayUI(ch) {
  const statusEl = document.getElementById(`relay${ch}Status`);
  const onBtn = document.getElementById(`relay${ch}On`);
  const offBtn = document.getElementById(`relay${ch}Off`);
  
  const state = relayStates[ch];
  statusEl.innerText = state;
  statusEl.style.color = state === 'ON' ? 'limegreen' : 'red';
  
  if(state === 'ON') {
    onBtn.className = 'on';    // ON button GREEN (active)
    offBtn.className = 'off';  // OFF button RED (ready)
  } else {
    onBtn.className = 'off';   // ON button RED (ready)
    offBtn.className = 'on';   // OFF button GREEN (active)
  }
}

function sendCommand(ch, cmd) {
  if(client.connected) {
    console.log(`Sending relay${ch}/control: ${cmd}`);
    client.publish(`relay${ch}/control`, cmd);
  } else {
    alert('MQTT not connected!');
  }
}

// Initialize UI
window.onload = function() {
  for(let ch=1; ch<=4; ch++) {
    updateRelayUI(ch);
  }
};

client.on('connect', () => {
  document.getElementById('mqttStatus').innerText = 'MQTT: Connected ✅';
  document.getElementById('mqttStatus').style.color = 'limegreen';
  client.subscribe([
    'relay1/status','relay2/status','relay3/status','relay4/status',
    'esp/+/status','esp/+/ip','esp/+/uptime'
  ]);
});

client.on('message', (topic, message) => {
  const msg = message.toString();
  console.log(`Received: ${topic} = ${msg}`);
  
  // Relay status update
  if(topic.match(/^relay[1-4]\/status$/)) {
    const ch = parseInt(topic.charAt(5));
    relayStates[ch] = msg;
    updateRelayUI(ch);
  }
  
  // ESP status
  if(topic.match(/^esp\/\d+\/status$/)) {
    const el = document.getElementById('espStatus');
    el.innerText = msg;
    el.className = msg === 'ONLINE' ? 'online' : 'offline';
  }
  
  if(topic.match(/^esp\/\d+\/ip$/)) document.getElementById('espIP').innerText = msg;
  if(topic.match(/^esp\/\d+\/uptime$/)) document.getElementById('espUptime').innerText = msg;
});
</script>
</body>
</html>
