<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4-Channel Relay Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; background:#f4f4f9; color:#333; }
  h2 { margin-top: 20px; }
  .relay-container { margin: 15px auto; }
  button { width: 120px; height: 50px; font-size:18px; margin:5px; border:none; border-radius:10px; cursor:pointer; color:white; }
  button:active { transform:translateY(2px); }
  .on { background: limegreen; }
  .off { background: tomato; }

  #espStatus, #mqttStatus { font-weight:bold; font-size:18px; margin-top:10px; }
  .online { color: limegreen; font-weight: bold; }
  .offline { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>ðŸ”§ 4-Channel Relay Control</h2>

<div class="relay-container">
  <p>Relay 1: <span id="relay1Status">Waiting...</span></p>
  <button id="r1Btn1" class="off" onclick="toggleRelay(1)">TOGGLE R1</button>
</div>

<div class="relay-container">
  <p>Relay 2: <span id="relay2Status">Waiting...</span></p>
  <button id="r2Btn1" class="off" onclick="toggleRelay(2)">TOGGLE R2</button>
</div>

<div class="relay-container">
  <p>Relay 3: <span id="relay3Status">Waiting...</span></p>
  <button id="r3Btn1" class="off" onclick="toggleRelay(3)">TOGGLE R3</button>
</div>

<div class="relay-container">
  <p>Relay 4: <span id="relay4Status">Waiting...</span></p>
  <button id="r4Btn1" class="off" onclick="toggleRelay(4)">TOGGLE R4</button>
</div>

<hr>
<p>ESP: <span id="espStatus" class="offline">OFFLINE</span></p>
<p>IP: <b id="espIP">--</b> | Uptime: <b id="espUptime">--</b></p>
<p id="mqttStatus">MQTT: Disconnected</p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const client = mqtt.connect('wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt', {
  username: 'tohits', password: 'toh123@TOH', reconnectPeriod: 1000
});

let relayStates = {1: 'UNKNOWN', 2: 'UNKNOWN', 3: 'UNKNOWN', 4: 'UNKNOWN'};

function updateRelayUI(ch, state) {
  const statusEl = document.getElementById(`relay${ch}Status`);
  const btn = document.getElementById(`r${ch}Btn1`);
  
  relayStates[ch] = state;
  statusEl.innerText = state;
  
  if(state === 'ON') {
    statusEl.style.color = 'limegreen';
    btn.innerText = 'TURN OFF';
    btn.className = 'on';
  } else {
    statusEl.style.color = 'red';
    btn.innerText = 'TURN ON';
    btn.className = 'off';
  }
}

function toggleRelay(ch) {
  const current = relayStates[ch];
  const nextCmd = (current === 'ON') ? 'OFF' : 'ON';
  
  if(client.connected) {
    client.publish(`relay${ch}/control`, nextCmd);
    console.log(`Toggle R${ch}: ${nextCmd}`);
  } else {
    alert('MQTT Offline!');
  }
}

client.on('connect', () => {
  document.getElementById('mqttStatus').innerText = 'MQTT: Connected âœ…';
  document.getElementById('mqttStatus').style.color = 'limegreen';
  client.subscribe(['relay1/status','relay2/status','relay3/status','relay4/status',
                   'esp/+/status','esp/+/ip','esp/+/uptime','devices/+/status','devices/+/ip','devices/+/uptime']);
});

client.on('message', (topic, message) => {
  const msg = message.toString();
  
  // Relay status
  if(topic.match(/^relay[1-4]\/status$/)) {
    const ch = parseInt(topic.charAt(5));
    updateRelayUI(ch, msg);
  }
  
  // ESP status
  if(topic.match(/^(esp|devices)\/[a-f0-9\d]+\/status$/)) {
    const el = document.getElementById('espStatus');
    el.innerText = msg;
    el.className = msg === 'ONLINE' ? 'online' : 'offline';
  }
  
  if(topic.match(/^(esp|devices)\/[a-f0-9\d]+\/ip$/)) document.getElementById('espIP').innerText = msg;
  if(topic.match(/^(esp|devices)\/[a-f0-9\d]+\/uptime$/)) document.getElementById('espUptime').innerText = msg;
});
</script>
</body>
</html>
